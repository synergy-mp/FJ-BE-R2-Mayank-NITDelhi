<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satoshi Portfolio Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btc-ticker { background: #f7931a; color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #0056b3; }
        .card { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div class="container">
        <div id="btc-ticker" class="btc-ticker">Loading Bitcoin Price...</div>

        <div id="auth">
            <h2>üîê Login to Satoshi Tracker</h2>
            <a href="/auth/google"><button style="background: #db4437;">Sign in with Google</button></a>
        </div>

        <div id="app" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <select id="globalCurrency" onchange="loadData()" style="width:auto;">
                    <option value="USD">Display: USD ($)</option>
                    <option value="INR">Display: INR (‚Çπ)</option>
                    <option value="SATS">Display: Sats (‚ö°)</option>
                </select>
                <button onclick="window.location.href='/'" style="width:auto; background:#666;">Logout</button>
            </div>

            <h2 style="text-align:center;" id="stats">Loading...</h2>
            <canvas id="financeChart"></canvas>

            <div class="grid">
                <div>
                    <h3>üìù Add Transaction</h3>
                    <input type="text" id="desc" placeholder="Description">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="amt" placeholder="Amount">
                        <select id="curr">
                            <option value="SATS">Sats</option>
                            <option value="USD">USD</option>
                            <option value="INR">INR</option>
                        </select>
                    </div>
                    <select id="type"><option value="INCOME">Income</option><option value="EXPENSE">Expense</option></select>
                    <input type="text" id="cat" placeholder="Category">
                    <button onclick="addTxn()">Add Transaction</button>
                </div>
                <div>
                    <h3>üëÄ Watch Bitcoin Address</h3>
                    <input type="text" id="watchAddr" placeholder="Paste BTC Address (bc1q...)">
                    <button onclick="checkAddress()" style="background:#f7931a;">Check Balance</button>
                    <div id="addrResult" style="margin-top:10px; font-weight:bold;"></div>
                    <div id="txns"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '';
        let userId = null;
        let myChart = null;

        window.onload = () => {
            // 1. Fetch Price Immediately (Even if not logged in)
            fetchTicker();

            // 2. Check Login Status
            const params = new URLSearchParams(window.location.search);
            if (params.get('userId')) { 
                userId = params.get('userId'); 
                document.getElementById('auth').style.display='none'; 
                document.getElementById('app').style.display='block'; 
                loadData(); 
            }
        };

        async function fetchTicker() {
            try {
                const res = await fetch('/api/ticker');
                const data = await res.json();
                document.getElementById('btc-ticker').innerText = `üî• Live Bitcoin Price: $${Math.floor(data.price).toLocaleString()} USD`;
            } catch (e) {
                console.log("Ticker waiting for server...");
            }
        }

        async function loadData() {
            const curr = document.getElementById('globalCurrency').value;
            const res = await fetch(`/dashboard/${userId}?currency=${curr}`);
            const data = await res.json();
            
            // Also update ticker here to keep it fresh
            if(data.btc_price) {
                document.getElementById('btc-ticker').innerText = `üî• Live Bitcoin Price: $${Math.floor(data.btc_price).toLocaleString()} USD`;
            }

            const symbol = curr === 'SATS' ? '‚ö°' : (curr === 'USD' ? '$' : '‚Çπ');
            document.getElementById('stats').innerText = `Net Worth: ${symbol}${(data.income - data.expense).toLocaleString()}`;

            const ctx = document.getElementById('financeChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, { 
                type: 'doughnut', 
                data: { labels: ['Income', 'Expense'], datasets: [{ data: [data.income, data.expense], backgroundColor: ['#28a745', '#dc3545'] }] } 
            });

            const txRes = await fetch(`/transactions/${userId}`);
            const txns = await txRes.json();
            document.getElementById('txns').innerHTML = txns.slice(0, 5).map(t => 
                `<div class="card"><span>${t.description}</span><span>${t.amount} ${t.currency}</span></div>`
            ).join('');
        }

        async function addTxn() {
            const fd = new FormData();
            fd.append('userId', userId); fd.append('description', document.getElementById('desc').value);
            fd.append('amount', document.getElementById('amt').value); fd.append('currency', document.getElementById('curr').value);
            fd.append('type', document.getElementById('type').value); fd.append('category', document.getElementById('cat').value);
            await fetch('/transactions', { method: 'POST', body: fd });
            loadData();
        }

        async function checkAddress() {
            const addr = document.getElementById('watchAddr').value;
            if(!addr) return alert("Enter address");
            document.getElementById('addrResult').innerText = "Scanning...";
            try {
                const res = await fetch(`/api/bitcoin-balance/${addr}`);
                const data = await res.json();
                document.getElementById('addrResult').innerHTML = `Balance: ${data.sats.toLocaleString()} Sats (‚âà$${data.usd_value.toFixed(2)})`;
            } catch (err) { document.getElementById('addrResult').innerText = "Address not found"; }
        }
    </script>
</body>
</html>